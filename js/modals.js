// Modal functionality
class ModalManager {
    static instance = null;

    constructor() {
        if (ModalManager.instance) {
            return ModalManager.instance;
        }

        this.modalsContainer = document.getElementById('modalsContainer');
        this.currentModal = null;
        this.escapeHandler = null; // Para poder remover el listener correctamente

        ModalManager.instance = this;
        this.init();
    }

    static getInstance() {
        if (!ModalManager.instance) {
            ModalManager.instance = new ModalManager();
        }
        return ModalManager.instance;
    }

    init() {
        // Listen for modal events
        window.appEvents.on('openModal', (modalData) => {
            this.openModal(modalData);
        });

        window.appEvents.on('closeModal', () => {
            this.closeModal();
        });
    }
  
// Abrir modal gen√©rico
openModal(modalData) {
  if (!this.modalsContainer) return;

  this.closeModal(); // siempre cerramos el modal actual antes de mostrar uno nuevo

  const modal = this.createModal(modalData);
  this.modalsContainer.appendChild(modal);
  this.currentModal = modal;

  // Mostrar con animaci√≥n
  setTimeout(() => modal.classList.add('show'), 10);

  // Handlers de cierre
  this.setupCloseHandlers(modal);

  // Ejecutar funci√≥n espec√≠fica si la hay (como asignar eventos)
  if (modalData.onShow) modalData.onShow(modal);
}

    
  
    closeModal() {
        if (this.currentModal) {
            this.currentModal.classList.remove('show');
            this.removeEventListeners(); // Limpiar listeners

            setTimeout(() => {
                if (this.currentModal && this.currentModal.parentNode) {
                    this.currentModal.parentNode.removeChild(this.currentModal);
                }
                this.currentModal = null;
            }, 300);
        }
    }
  
    createModal(modalData) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      
      overlay.innerHTML = `
        <div class="modal ${modalData.className || ''}">
          <div class="modal-header">
            <h3 class="modal-title">${modalData.title}</h3>
            <button class="modal-close" type="button">√ó</button>
          </div>
          <div class="modal-body">
            ${modalData.body}
          </div>
          ${modalData.footer ? `<div class="modal-footer">${modalData.footer}</div>` : ''}
        </div>
      `;
      
      return overlay;
    }
  
    setupCloseHandlers(modal) {
      const closeBtn = modal.querySelector('.modal-close');
      const overlay = modal;
      
      closeBtn.addEventListener('click', () => this.closeModal());
      
      overlay.addEventListener('click', (e) => {
        const modalContent = overlay.querySelector('.modal');
        if (!modalContent.contains(e.target)) {
          this.closeModal();
        }
      });
      
      
      // Close on Escape key
      this.escapeHandler = (e) => {
        if (e.key === 'Escape') {
          this.closeModal();
        }
      };
      document.addEventListener('keydown', this.escapeHandler);
    }
  
    removeEventListeners() {
        if (this.escapeHandler) {
            document.removeEventListener('keydown', this.escapeHandler);
            this.escapeHandler = null;
        }
    }
    reattachCloseHandlers() {
      if (!this.currentModal) return;
  
      // Elimina el listener de Escape que pudiera quedar colgado
      this.removeEventListeners();
  
      const closeBtn = this.currentModal.querySelector('.modal-close');
      const overlay  = this.currentModal;   // overlay = elemento .modal‚Äëoverlay
  
      // Bot√≥n X
      if (closeBtn) {
        closeBtn.addEventListener('click', () => this.closeModal());
      }
  
      // Click fuera del contenido
      overlay.addEventListener('click', e => {
        if (e.target === overlay) this.closeModal();
      });
  
      // Tecla Escape
      this.escapeHandler = e => {
        if (e.key === 'Escape') this.closeModal();
      };
      document.addEventListener('keydown', this.escapeHandler);
    }

    // Specific modal creators
// --- Crear subcategor√≠a ---
static createSubcategoryModal(categoryId) {
  const defaultFrequency = 'mensual';
  const defaultStartDate = Helpers.getDefaultStartDate(defaultFrequency);
  const defaultEndDate = Helpers.getEndDate(defaultStartDate, defaultFrequency);

  const modalConfig = {
    title: 'Crear Subcategor√≠a',
    className: 'subcategory-modal',
    body: `
      <form class="modal-form" id="subcategoryForm">
        <div class="form-group">
          <label for="subcategoryName">Nombre de la subcategor√≠a</label>
          <input type="text" id="subcategoryName" name="name" required>
        </div>
        <div class="form-group">
          <label for="subcategoryBudget">Presupuesto</label>
          <input type="number" id="subcategoryBudget" name="budget" required step="0.01" min="0">
        </div>
        <div class="form-group">
          <label for="subcategoryFrequency">Frecuencia</label>
          <select id="subcategoryFrequency" name="frequency" required>
            <option value="semanal">Semanal</option>
            <option value="mensual" selected>Mensual</option>
            <option value="trimestral">Trimestral</option>
            <option value="anual">Anual</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subcategoryStartDate">Fecha de inicio del presupuesto</label>
          <input type="date" id="subcategoryStartDate" name="startDate" required value="${defaultStartDate}">
          <small id="subcategoryInfo" class="info-text">
            √öltimo d√≠a: ${Helpers.formatLocalDate(defaultEndDate)}
          </small>
        </div>
        <input type="hidden" name="categoryId" value="${categoryId}">
      </form>
    `,
    footer: `
      <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
      <button type="submit" class="btn-primary" form="subcategoryForm">Crear Subcategor√≠a</button>
    `
  };

  setTimeout(() => {
    const freqSelect = document.getElementById('subcategoryFrequency');
    const startInput = document.getElementById('subcategoryStartDate');
    const info = document.getElementById('subcategoryInfo');

    function updateInfo() {
      const frequency = freqSelect.value;
      const startDate = startInput.value;
      if (startDate) {
        const endDate = Helpers.getEndDate(startDate, frequency);
        info.textContent = `√öltimo d√≠a: ${Helpers.formatLocalDate(endDate)}`;
      }
    }

    if (freqSelect && startInput) {
      freqSelect.addEventListener('change', () => {
        startInput.value = Helpers.getDefaultStartDate(freqSelect.value);
        updateInfo();
      });
      startInput.addEventListener('change', updateInfo);
      updateInfo();
    }


  }, 0);

  return modalConfig;
}



static editSubcategoryModal(subcategory) {
  const defaultStartDate = subcategory.startDate || Helpers.getDefaultStartDate(subcategory.frequency);
  const defaultEndDate = Helpers.getEndDate(defaultStartDate, subcategory.frequency);

  const category = AppState.categories.find(c => c.id === subcategory.categoryId);
  const expenses = Storage.getExpenses();
  const hasExpenses = expenses.some(exp => exp.subcategoryId === subcategory.id);

  const modalConfig = {
    title: 'Editar Subcategor√≠a',
    className: 'subcategory-modal',
    body: `
      <form class="modal-form" id="editSubcategoryForm">
        <!-- Secci√≥n edici√≥n -->
        <div id="editSection">
          <div class="form-group">
            <label for="editSubcategoryName">Nombre de la subcategor√≠a</label>
            <input type="text" id="editSubcategoryName" name="name" required value="${subcategory.name}">
          </div>

          <div class="form-group">
            <label for="editSubcategoryBudget">Presupuesto</label>
            <input type="number" id="editSubcategoryBudget" name="budget" required value="${subcategory.budget}" step="0.01" min="0">
          </div>

          <div class="form-group">
            <label for="editSubcategoryFrequency">Frecuencia</label>
            <select id="editSubcategoryFrequency" name="frequency" required>
              <option value="semanal" ${subcategory.frequency === 'semanal' ? 'selected' : ''}>Semanal</option>
              <option value="mensual" ${subcategory.frequency === 'mensual' ? 'selected' : ''}>Mensual</option>
              <option value="trimestral" ${subcategory.frequency === 'trimestral' ? 'selected' : ''}>Trimestral</option>
              <option value="anual" ${subcategory.frequency === 'anual' ? 'selected' : ''}>Anual</option>
            </select>
          </div>

          <div class="form-group">
            <label for="editSubcategoryStartDate">Fecha de inicio del presupuesto</label>
            <input type="date" id="editSubcategoryStartDate" name="startDate" required value="${defaultStartDate}">
            <small id="editSubcategoryInfo" class="info-text">
              √öltimo d√≠a: ${Helpers.formatLocalDate(defaultEndDate)}
            </small>
          </div>

          <div class="form-group delete-subcategory">
            <button type="button" class="btn-text-danger" id="triggerDeleteBtn">üóëÔ∏è Eliminar subcategor√≠a</button>
          </div>
        </div>

        <!-- Secci√≥n eliminaci√≥n -->
        <div id="deleteSection" style="display: none; margin-top: 1rem;">
          ${hasExpenses ? `
            <p>La subcategor√≠a <strong>${subcategory.name}</strong> tiene gastos asociados.</p>
            <div class="delete-options">
              <div class="delete-option card-option" data-option="delete">
                <h4>üóëÔ∏è Eliminar gastos</h4>
                <p>Todos los gastos asociados ser√°n eliminados junto con la subcategor√≠a.</p>
              </div>
              <div class="delete-option card-option" data-option="move">
                <h4>üìÇ Mover gastos</h4>
                <p>Conserva los gastos y mu√©velos a otra subcategor√≠a.</p>
                <div id="subcategorySelectWrapper" style="display:none; margin-top:0.5rem;"></div>
              </div>
            </div>
          ` : `
            <p>¬øDeseas eliminar la subcategor√≠a <strong>${subcategory.name}</strong>?</p>
          `}
        </div>

        <input type="hidden" name="subcategoryId" value="${subcategory.id}">
        <input type="hidden" name="categoryId" value="${subcategory.categoryId}">
      </form>
    `,
    footer: `
      <button type="button" class="btn-secondary" id="modalCancelBtn">Cancelar</button>
      <button type="submit" class="btn-primary" form="editSubcategoryForm" id="modalSubmitBtn">Guardar</button>
    `,
    onShow: (modal) => {
      const editSection = modal.querySelector('#editSection');
      const deleteSection = modal.querySelector('#deleteSection');
      const modalTitle = modal.querySelector('.modal-title');
      const freqSelect = modal.querySelector('#editSubcategoryFrequency');
      const startInput = modal.querySelector('#editSubcategoryStartDate');
      const info = modal.querySelector('#editSubcategoryInfo');
      const triggerDeleteBtn = modal.querySelector('#triggerDeleteBtn');
      const cancelBtn = modal.querySelector('#modalCancelBtn');
      const submitBtn = modal.querySelector('#modalSubmitBtn');
      const wrapper = modal.querySelector('#subcategorySelectWrapper');

      // Actualizar info de fechas
      function updateInfo() {
        const frequency = freqSelect.value;
        const startDate = startInput.value;
        if (startDate) {
          const endDate = Helpers.getEndDate(startDate, frequency);
          info.textContent = `√öltimo d√≠a: ${Helpers.formatLocalDate(endDate)}`;
        }
      }
      freqSelect.addEventListener('change', () => {
        startInput.value = Helpers.getDefaultStartDate(freqSelect.value);
        updateInfo();
      });
      startInput.addEventListener('change', updateInfo);
      updateInfo();

      // Guardar cambios de edici√≥n
      function saveEdit(e) {
        e.preventDefault();
        const formData = new FormData(modal.querySelector('#editSubcategoryForm'));
        Storage.updateSubcategory(formData.get('categoryId'), formData.get('subcategoryId'), {
          name: formData.get('name'),
          budget: parseFloat(formData.get('budget')),
          frequency: formData.get('frequency'),
          startDate: formData.get('startDate')
        });
        AppState.refreshData();
        Helpers.showToast('Subcategor√≠a actualizada', 'success');
        window.appEvents.emit('closeModal');
      }
      submitBtn.onclick = saveEdit;

      // Cancelar
      cancelBtn.onclick = () => window.appEvents.emit('closeModal');

      // Modo eliminaci√≥n
      triggerDeleteBtn.addEventListener('click', () => {
        editSection.style.display = 'none';
        deleteSection.style.display = 'block';
        modalTitle.textContent = 'Eliminar Subcategor√≠a';
        submitBtn.textContent = 'Eliminar';

        let deleteChoice = 'delete';
        const deleteOptions = modal.querySelectorAll('.delete-option');

        deleteOptions.forEach(opt => {
          opt.addEventListener('click', () => {
            deleteOptions.forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            deleteChoice = opt.dataset.option;

            if (deleteChoice === 'move') {
              wrapper.style.display = 'block';
              wrapper.innerHTML = '';
              const select = Helpers.buildSubcategorySelect(null, subcategory.id);
              
              // ‚ö° Evita que los clics dentro del select afecten al card-option padre
              select.addEventListener('click', e => e.stopPropagation());
              select.addEventListener('change', e => e.stopPropagation());
              
              wrapper.appendChild(select);
            } else {
              wrapper.style.display = 'none';
            }
            
          });
        });

        // Confirmar eliminaci√≥n
        submitBtn.onclick = (e) => {
          e.preventDefault();

          let targetId = null;
          if (deleteChoice === 'move') {
            targetId = wrapper.querySelector('select[name="targetSubcategory"]')?.value;
            if (!targetId) {
              Helpers.showToast('Selecciona una subcategor√≠a destino', 'error');
              return;
            }
          }

          Storage.deleteSubcategory(subcategory.categoryId, subcategory.id, {
            action: deleteChoice,
            targetSubcategoryId: targetId
          });

          AppState.refreshData();
          Helpers.showToast(
            deleteChoice === 'delete'
              ? 'Subcategor√≠a y gastos eliminados'
              : 'Subcategor√≠a eliminada y gastos movidos',
            'success'
          );

          window.appEvents.emit('closeModal');
        };
      });
    }
  };

  return modalConfig;
}






static editCategoryModal(category) {
  const hasSubcategories = category.subcategories?.length > 0;
  const otherCategories = (AppState.categories || []).filter(c => c.id !== category.id);

  return {
    title: 'Editar Categor√≠a',
    className: 'category-modal',
    body: `
      <form class="modal-form" id="editCategoryForm">
        <!-- Secci√≥n edici√≥n -->
        <div id="editCategorySection">
          <div class="form-group">
            <label for="editCategoryName">Nombre de la categor√≠a</label>
            <input type="text" id="editCategoryName" name="name" required 
                   value="${category.name || ''}">
          </div>
          <div class="form-group">
            <label for="editCategoryDescription">Descripci√≥n (opcional)</label>
            <input type="text" id="editCategoryDescription" name="description" 
                   value="${category.description || ''}">
          </div>

          <div class="form-group delete-category">
            <button type="button" class="btn-text-danger" id="triggerDeleteCategoryBtn">
              üóëÔ∏è Eliminar categor√≠a
            </button>
          </div>
        </div>

        <!-- Secci√≥n eliminaci√≥n -->
        <div id="deleteCategorySection" style="display: none; margin-top: 1rem;">
          ${hasSubcategories ? `
            <p>La categor√≠a <strong>${category.name}</strong> contiene subcategor√≠as y gastos.</p>

            <div class="delete-options">
              <div class="delete-option card-option" data-option="delete">
                <h4>üóëÔ∏è Eliminar todo</h4>
                <p>Se eliminar√°n la categor√≠a, sus subcategor√≠as y todos los gastos asociados.</p>
              </div>
              <div class="delete-option card-option ${otherCategories.length ? '' : 'disabled'}" data-option="move">
                <h4>üìÇ Mover subcategor√≠as</h4>
                <p>Mover todas las subcategor√≠as (y sus gastos) a otra categor√≠a.</p>
                <div id="categorySelectWrapper" style="display:none; margin-top:0.5rem;"></div>
              </div>
            </div>
          ` : `
            <p>¬øDeseas eliminar la categor√≠a <strong>${category.name}</strong>?</p>
          `}
        </div>

        <input type="hidden" name="categoryId" value="${category.id}">
      </form>
    `,
    footer: `
      <button type="button" class="btn-secondary" id="categoryCancelBtn">Cancelar</button>
      <button type="submit" class="btn-primary" form="editCategoryForm" id="categorySubmitBtn">Guardar</button>
    `,
    onShow: (modal) => {
      const editSection = modal.querySelector('#editCategorySection');
      const deleteSection = modal.querySelector('#deleteCategorySection');
      const modalTitle = modal.querySelector('.modal-title');
      const submitBtn = modal.querySelector('#categorySubmitBtn');
      const cancelBtn = modal.querySelector('#categoryCancelBtn');
      const triggerDeleteBtn = modal.querySelector('#triggerDeleteCategoryBtn');
      const wrapper = modal.querySelector('#categorySelectWrapper');

      // Guardar cambios
      function saveEdit(e) {
        e.preventDefault();
        const formData = new FormData(modal.querySelector('#editCategoryForm'));
        Storage.updateCategory(formData.get('categoryId'), {
          name: formData.get('name'),
          description: formData.get('description')
        });
        AppState.refreshData();
        Helpers.showToast('Categor√≠a actualizada', 'success');
        window.appEvents.emit('closeModal');
      }
      submitBtn.onclick = saveEdit;

      // Cancelar ‚Üí cerrar modal
      cancelBtn.onclick = () => window.appEvents.emit('closeModal');

      // Pasar a modo eliminaci√≥n
      triggerDeleteBtn.addEventListener('click', () => {
        editSection.style.display = 'none';
        deleteSection.style.display = 'block';
        modalTitle.textContent = 'Eliminar Categor√≠a';
        submitBtn.textContent = 'Eliminar';

        let deleteChoice = null;

        // Construir select si corresponde
        if (wrapper && otherCategories.length) {
          wrapper.innerHTML = '';
          wrapper.appendChild(Helpers.buildCategorySelect(null, category.id));
        }

        // Selecci√≥n de opci√≥n
        const options = modal.querySelectorAll('.delete-option');
        options.forEach(opt => {
          if (opt.classList.contains('disabled')) return;
          opt.addEventListener('click', () => {
            options.forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            deleteChoice = opt.dataset.option;

            if (deleteChoice === 'move') {
              wrapper.style.display = 'block';
            } else {
              wrapper.style.display = 'none';
            }
          });
        });

        // Confirmar eliminaci√≥n
        submitBtn.onclick = (e) => {
          e.preventDefault();

          if (hasSubcategories) {
            if (!deleteChoice) {
              Helpers.showToast('Selecciona una opci√≥n para continuar', 'error');
              return;
            }

            let targetId = null;
            if (deleteChoice === 'move') {
              targetId = wrapper.querySelector('select[name="targetCategory"]')?.value;
              if (!targetId) {
                Helpers.showToast('Selecciona una categor√≠a destino', 'error');
                return;
              }
            }

            Storage.deleteCategory(category.id, {
              action: deleteChoice,
              targetCategoryId: targetId
            });
            Helpers.showToast(
              deleteChoice === 'delete'
                ? 'Categor√≠a y subcategor√≠as eliminadas'
                : 'Categor√≠a eliminada y subcategor√≠as movidas',
              'success'
            );
          } else {
            Storage.deleteCategory(category.id, { action: 'delete' });
            Helpers.showToast('Categor√≠a eliminada', 'success');
          }

          AppState.refreshData();
          window.appEvents.emit('closeModal');
        };
      });
    }
  };
}


    

    
    
    static createExpenseModal(subcategoryId, subcategoryName, remainingBudget, currency = 'BOB') {
      const selectedWallet = AppState.selectedWallet;
      const wallets = AppState.wallets;
      
      return {
        title: 'Gasto en '+ subcategoryName,
        className: 'expense-modal',
        body: `
          <div class="expense-info">
            <div class="expense-info-text">Presupuesto disponible:</div>
            <div class="remaining-budget">${Helpers.formatCurrency(remainingBudget, currency)}</div>
          </div>
          <form class="modal-form" id="expenseForm">
<div class="form-group">
  <label for="expenseDate">Fecha</label>
  <input type="date" id="expenseDate" name="date" required 
         value="${new Date().toLocaleDateString('en-CA')}">
</div>

            <div class="form-group">
              <label for="expenseWallet">Wallet</label>
              <select id="expenseWallet" name="walletId" required>
                ${wallets.map(wallet => `
                  <option value="${wallet.id}" ${selectedWallet && selectedWallet.id === wallet.id ? 'selected' : ''}>
                    ${wallet.name} (${Helpers.formatCurrency(wallet.balance, wallet.currency)})
                  </option>
                `).join('')}
              </select>
            </div>
            <div class="form-group">
              <label for="expenseName">Producto/Servicio</label>
              <input type="text" id="expenseName" name="name" required 
                     placeholder="ej: Almuerzo en restaurante">
            </div>
            <div class="form-group">
              <label for="expenseAmount">Valor <span class="currency-display" id="currencyDisplay">${currency}</span></label>
              <input type="number" id="expenseAmount" name="amount" required 
                     placeholder="0.00" step="0.01" min="0.01">
            </div>
            <input type="hidden" name="subcategoryId" value="${subcategoryId}">
          </form>
        `,
        footer: `
          <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
          <button type="submit" class="btn-primary" form="expenseForm">Agregar</button>
        `
      };
    }
// ------------------------------------------------------------
//  EDIT EXPENSE ‚Äì GASTO CLASIFICADO (ya tiene categor√≠a)
// ------------------------------------------------------------
static editExpenseModalClassified(expense, currency = 'BOB') {
  return {
    title: 'Editar Gasto',
    className: 'expense-modal',

    /* ----------  SOLO EL FORMULARIO  ---------- */
    body: `
      <form class="modal-form" id="editExpenseForm">
        <div class="form-group">
          <label for="editExpenseName">Producto/Servicio</label>
          <input type="text" id="editExpenseName" name="name" required
                 value="${expense.name}">
        </div>

        <div class="form-group">
          <label for="editExpenseAmount">Valor <span class="currency-display">${currency}</span></label>
          <input type="number" id="editExpenseAmount" name="amount" required
                 value="${expense.amount}" step="0.01" min="0.01">
        </div>

        <div class="form-group">
          <label for="editExpenseDate">Fecha</label>
          <input type="date" id="editExpenseDate" name="date" required
                 value="${expense.date}">
        </div>

        <div class="form-group">
          <label for="editExpenseWallet">Wallet</label>
          <select id="editExpenseWallet" name="walletId" required>
            ${AppState.wallets.map(w => `
              <option value="${w.id}" ${w.id === expense.walletId ? 'selected' : ''}>
                ${w.name} (${Helpers.formatCurrency(w.balance, w.currency)})
              </option>`).join('')}
          </select>
        </div>

        <!-- La sub‚Äëcategor√≠a ya est√° guardada ‚Üí la enviamos como hidden -->
        <input type="hidden" name="subcategoryId"
               value="${expense.subcategoryId}">

        <div class="form-group delete-expense">
          <button type="button" class="btn-text-danger"
                  onclick="window.gastosManager.handleDeleteExpense('${expense.id}')">
            üóëÔ∏è Eliminar gasto
          </button>
        </div>

        <input type="hidden" name="expenseId" value="${expense.id}">
      </form>
    `,

    /* ----------  FOOTER FUERA DEL FORMULARIO  ---------- */
    footer: `
      <button type="button" class="btn-secondary"
              onclick="window.appEvents.emit('closeModal')">Cancelar</button>
      <button type="submit" class="btn-primary"
              form="editExpenseForm">Guardar</button>
    `
  };
}
/**
 * Modal ‚Üí Clasificar un gasto que se cre√≥ con ‚ÄúGasto r√°pido‚Äù.
 * Contiene un <select> para elegir la sub‚Äëcategor√≠a a la que se quiere
 * asignar el gasto.
 */
// ------------------------------------------------------------
//  EDIT EXPENSE ‚Äì GASTO SIN CLASIFICAR (quick‚Äëexpense)
// ------------------------------------------------------------
static editExpenseModalUnclassified(expense, currency = 'BOB') {
  return {
    title: 'Clasificar Gasto',
    className: 'expense-modal',

    body: `
      <form class="modal-form" id="editExpenseForm">
        <div class="form-group">
          <label for="editExpenseName">Producto/Servicio</label>
          <input type="text" id="editExpenseName" name="name" required
                 value="${expense.name}">
        </div>

        <div class="form-group">
          <label for="editExpenseAmount">Valor <span class="currency-display">${currency}</span></label>
          <input type="number" id="editExpenseAmount" name="amount" required
                 value="${expense.amount}" step="0.01" min="0.01">
        </div>

        <div class="form-group">
          <label for="editExpenseDate">Fecha</label>
          <input type="date" id="editExpenseDate" name="date" required
                 value="${expense.date}">
        </div>

        <div class="form-group">
          <label for="editExpenseWallet">Wallet</label>
          <select id="editExpenseWallet" name="walletId" required>
            ${AppState.wallets.map(w => `
              <option value="${w.id}" ${w.id === expense.walletId ? 'selected' : ''}>
                ${w.name} (${Helpers.formatCurrency(w.balance, w.currency)})
              </option>`).join('')}
          </select>
        </div>

        <div class="form-group" id="subcategory-container">
          <label for="expenseSubcategory">Clasificar en</label>
          <select id="expenseSubcategory" name="subcategoryId" required>
            <option value="">-- Selecciona para clasificar --</option>
          </select>
        </div>

        <div class="form-group delete-expense">
          <button type="button" class="btn-text-danger"
                  onclick="window.gastosManager.handleDeleteExpense('${expense.id}')">
            üóëÔ∏è Eliminar gasto
          </button>
        </div>

        <input type="hidden" name="expenseId" value="${expense.id}">

        <!-- MOVEMOS EL FOOTER DENTRO DEL FORM -->
        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="cancelButton">Cancelar</button>
          <button type="submit" class="btn-primary">Clasificar</button>
        </div>
      </form>
    `
  };
}

    static createWalletModal() {
      const currencies = [
        { code: 'BOB', name: 'Boliviano' },
        { code: 'USD', name: 'D√≥lar' },
        { code: 'EUR', name: 'Euro' },
        { code: 'BCH', name: 'Bitcoin Cash' }
      ];
  
      return {
        title: 'Nueva Wallet',
        className: 'wallet-modal',
        body: `
          <form class="modal-form" id="walletForm">
            <div class="form-group">
              <label for="walletName">Nombre de la wallet/wallet</label>
              <input type="text" id="walletName" name="name" required 
                     placeholder="ej: Wallet Corriente">
            </div>
            <div class="form-group">
              <label for="walletCurrency">Moneda</label>
              <div class="currency-grid">
                ${currencies.map((currency, index) => `
                  <div class="currency-option ${index === 0 ? 'selected' : ''}" data-currency="${currency.code}">
                    <div class="currency-code">${currency.code}</div>
                    <div class="currency-name">${currency.name}</div>
                  </div>
                `).join('')}
              </div>
              <input type="hidden" id="walletCurrency" name="currency" value="BOB">
            </div>
            <div class="form-group">
              <label for="walletBalance">Cantidad inicial</label>
              <input type="number" id="walletBalance" name="balance" required 
                     placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
              <label for="walletPurpose">Prop√≥sito (opcional)</label>
              <input type="text" id="walletPurpose" name="purpose" 
                     placeholder="ej: Gastos diarios">
            </div>
          </form>
        `,
        footer: `
          <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
          <button type="submit" class="btn-primary" form="walletForm">Crear Wallet</button>
        `
      };
    }
  
    static createIncomeModal(walletId) {
      const wallet = AppState.wallets.find(acc => acc.id === walletId);
      const incomeSources = Storage.getIncomeSources();
  
      return {
        title: 'Agregar Ingreso',
        className: 'income-modal',
        body: `
          <form class="modal-form" id="incomeForm">
            <div class="form-group">
              <label for="incomeAmount">Cantidad</label>
              <div class="input-with-currency">
                <input type="number" id="incomeAmount" name="amount" required 
                      placeholder="0.00" step="0.01" min="0.01">
                <span class="currency-display">${wallet ? wallet.currency : 'BOB'}</span>
              </div>
            </div>
            <div class="form-group">
              <label>Fuente del dinero</label>
              <div class="source-list">
                ${incomeSources.map(source => `
                  <div class="source-item" data-source="${source}">${source}</div>
                `).join('')}
              </div>
              <div class="add-source-section">
                <div class="add-source-input">
                  <input type="text" id="newSource" placeholder="Nueva fuente...">
                  <button type="button" class="add-source-btn" id="addSourceBtn">Agregar</button>
                </div>
              </div>
              <input type="hidden" id="incomeSource" name="source" required>
            </div>
            <div class="form-group">
              <label for="incomeDescription">Descripci√≥n (opcional)</label>
              <input type="text" id="incomeDescription" name="description" 
                     placeholder="ej: Sueldo de enero">
            </div>
            <input type="hidden" name="walletId" value="${walletId}">
          </form>
        `,
        footer: `
          <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
          <button type="submit" class="btn-primary" form="incomeForm">Agregar Ingreso</button>
        `
      };
    }
  
    static createTransferModal(fromWalletId) {
      const wallets = AppState.wallets.filter(acc => acc.id !== fromWalletId);
      const fromWallet = AppState.wallets.find(acc => acc.id === fromWalletId);
  
      return {
        title: 'Transferir Dinero',
        className: 'transfer-modal',
        body: `
          <form class="modal-form" id="transferForm">
            <div class="form-group">
              <label>Desde: ${fromWallet ? fromWallet.name : ''}</label>
              <div class="wallet-balance">
                Disponible: ${fromWallet ? Helpers.formatCurrency(fromWallet.balance, fromWallet.currency) : '0.00'}
              </div>
            </div>
            <div class="form-group">
              <label for="transferTo">Transferir a</label>
              <select id="transferTo" name="toWalletId" required>
                <option value="">Seleccionar wallet destino</option>
                ${wallets.map(wallet => `
                  <option value="${wallet.id}">
                    ${wallet.name} (${Helpers.formatCurrency(wallet.balance, wallet.currency)})
                  </option>
                `).join('')}
              </select>
            </div>
            <div class="form-group">
        <label for="transferAmount">Cantidad</label>
        <div class="input-with-currency">
          <input type="number" id="transferAmount" name="amount" required 
                placeholder="0.00" step="0.01" min="0.01" 
                max="${fromWallet ? fromWallet.balance : 0}">
          <span class="currency-display">${fromWallet ? fromWallet.currency : 'BOB'}</span>
        </div>
      </div>
            <div class="form-group">
              <label for="transferDescription">Descripci√≥n (opcional)</label>
              <input type="text" id="transferDescription" name="description" 
                     placeholder="ej: Pago de deuda">
            </div>
            <input type="hidden" name="fromWalletId" value="${fromWalletId}">
          </form>
        `,
        footer: `
          <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
          <button type="submit" class="btn-primary" form="transferForm">Transferir</button>
        `
      };
    }


    static createTransactionsModal(walletId) {
      const wallet = AppState.wallets.find(acc => acc.id === walletId);
      if (!wallet) return null;

      const transactions = Storage.get('ginbertfi_transactions') || [];
      const walletTransactions = transactions
        .filter(t => t.walletId === walletId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      return {
        title: `Transacciones - ${wallet.name}`,
        className: 'transactions-modal',
        body: `
          <div class="wallet-summary">
            <div class="wallet-balance">
              <span class="balance-label">Saldo actual:</span>
              <span class="balance-value">${Helpers.formatCurrency(wallet.balance, wallet.currency)}</span>
            </div>
          </div>
          <div class="transactions-list">
            ${walletTransactions.length === 0 ? `
              <div class="empty-transactions">
                <p>No hay transacciones registradas</p>
              </div>
            ` : walletTransactions.map(transaction => `
              <div class="transaction-item-modal ${transaction.type}">
                <div class="transaction-main">
                  <div class="transaction-info">
                    <div class="transaction-type">${this.getTransactionTypeLabel(transaction.type)}</div>
                    ${transaction.description ? `<div class="transaction-description">${transaction.description}</div>` : ''}
                    ${transaction.source ? `<div class="transaction-source">Fuente: ${transaction.source}</div>` : ''}
                  </div>
                  <div class="transaction-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                    ${transaction.amount > 0 ? '+' : ''}${Helpers.formatCurrency(Math.abs(transaction.amount), wallet.currency)}
                  </div>
                </div>
                <div class="transaction-date">${Helpers.formatDate(transaction.date)}</div>
              </div>
            `).join('')}
          </div>
        `,
        footer: `
          <button type="button" class="btn-primary" onclick="window.appEvents.emit('closeModal')">Cerrar</button>
        `
      };
    }

    static createCategoryModal() {
      return {
        title: 'Nueva Categor√≠a',
        className: 'category-modal',
        body: `
          <form class="modal-form" id="categoryForm">
            <div class="form-group">
              <label for="categoryName">Nombre de la categor√≠a</label>
              <input type="text" id="categoryName" name="name" required 
                     placeholder="ej: Alimentaci√≥n">
            </div>
            <div class="form-group">
              <label for="categoryDescription">Descripci√≥n (opcional)</label>
              <input type="text" id="categoryDescription" name="description" 
                     placeholder="ej: Gastos relacionados con comida">
            </div>
          </form>
        `,
        footer: `
          <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
          <button type="submit" class="btn-primary" form="categoryForm">Crear Categor√≠a</button>
        `
      };
    }
// üöÄ NUEVA FUNCI√ìN para el Gasto R√°pido
static createQuickExpenseModal() {
  const wallets = AppState.wallets;
  // Obtenemos la wallet activa para preseleccionarla y hacer el proceso m√°s r√°pido
  const activeWalletId = Storage.get('ginbertfi_activeWalletId') || (wallets.length > 0 ? wallets[0].id : '');

  // Generamos las opciones para el selector de wallets
  const walletOptions = wallets.map(wallet => 
      `<option value="${wallet.id}" ${wallet.id === activeWalletId ? 'selected' : ''}>
          ${wallet.name} (${Helpers.formatCurrency(wallet.balance, wallet.currency)})
      </option>`
  ).join('');

  return {
      title: 'Gasto R√°pido',
      className: 'expense-modal',
      body: `
          <form class="modal-form" id="quickExpenseForm">
              <div class="form-group">
                  <label for="quickExpenseName">Nombre del Gasto</label>
                  <input type="text" id="quickExpenseName" name="name" required placeholder="ej: Caf√© y pastel">
              </div>
              <div class="form-group">
                  <label for="quickExpenseAmount">Monto</label>
                  <input type="number" id="quickExpenseAmount" name="amount" step="0.01" required placeholder="0.00">
              </div>
              <div class="form-group">
                  <label for="quickExpenseWallet">Pagar con</label>
                  <select id="quickExpenseWallet" name="walletId" required>
                      ${walletOptions}
                  </select>
              </div>
          </form>
      `,
      footer: `
          <button type="button" class="btn-secondary" onclick="window.appEvents.emit('closeModal')">Cancelar</button>
          <button type="submit" class="btn-primary" form="quickExpenseForm">Guardar Gasto</button>
      `
  };
}
    static getTransactionTypeLabel(type) {
      const labels = {
        'income': 'Ingreso',
        'expense': 'Gasto',
        'transfer_in': 'Transferencia recibida',
        'transfer_out': 'Transferencia enviada'
      };
      return labels[type] || type;
    }
  }
  
  // Initialize modal manager when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    ModalManager.getInstance();  
  });
  